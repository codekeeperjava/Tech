## 背景及问题

### 背景

该服务为资讯推荐服务，当用户请求时，会从 1000 条时间倒序排列的资讯内容（可以是 *提前准备好* 的，也可以是 *实时得到* 的）中，随机返回 10 条展示给用户。

这 1000 条时间倒序排列的资讯内容，如果每次查询数据库，将会给数据库带来巨大压力，因此我们需要将准备好的内容缓存起来，获取时先请求缓存，命中直接返回，否则再查询数据库。

### 遇到问题

通常，缓存一般分为两种：

- 本地缓存，如 Guava Cache，EhCache
- 分布式缓存，如 Redis

那么我们首先命令的问题是：**到底该选择本地缓存，还是选择分布式缓存？为什么？**

如果选择本地缓存，会存在 2 个问题：**1. 每个服务实例需要保存一份缓存，一致性是否能达到要求？空间是否足够？2. 服务每次重启，会丢失缓存，大量缓存重加载会导致服务变慢甚至不可用。**

如果选择分布式缓存，如 Redis，**Redis 缓存后，每次读取不能返回全部 1000 条，因为序列化及网络传输代价太高，需要直接返回随机 10 条内容，那选用什么样的数据结构合适？**

另外，不论本地缓存还是分布式缓存，**都需要考虑缓存击穿问题，** 本地缓存 Guava Cache 和 EhCache 都存在 key 过期后，返回旧值同时由一个线程更新缓存，可以很好的解决缓存击穿问题，但分布式缓存如何做到？

## 分析问题

### 需求特点

1. 数据一致性要求不高，保证最终一致性即可。
2. 缓存存储数据较大，但只使用小部分数据。

### 各个选型的特点

首先，Guava Cache、EhCache、Redis 都是广泛使用的主流缓存方案，大量应用于各个公司的生产环境，因此在使用方式正确的情况下无需担心他们的稳定性。

Guava Cache 和 EhCache 的区别：

1. Guava Cache 比 EhCache 更轻量级，因此前者较后者少了一些功能。
2. EhCache 支持持久化到本地磁盘中，可以用来服务中断后的重新加载。Guava 不支持。
3. EhCache 支持集群方案，Guava 没有。不过个人感觉比较鸡肋，对 JVM 级别的缓存来讲太重了。
4. EhCache 有内存占用大小统计，Guava Cache 没有，需要自己开发。
5. EhCache 在缓存时，会对 K、V 进行包装，对 GC 有一定影响。

分布式缓存和本地缓存的区别：

1. 本地缓存直接访问内存，没有网络 IO，因此效率更高。
2. 分布式缓存在集群环境下只保留一份数据（不考虑主备），减少了查询数据库的次数；本地缓存每个服务实例保存一份。
3. 本地缓存在服务重启时需要重新加载，分布式缓存不受服务启停的影响。
4. 对数据一致性要求不强烈时，本地缓存可以使用先返回旧值，然后异步加载的方式防止缓存击穿；分布式缓存如 Redis 需要自己手动实现。

### 选型

*该部分结合遇到问题中使用各个缓存存在的问题进行讨论*

#### 如果使用 Redis

因为网络 IO，每个请求传输 1000 个字符串，代价大，因此可以使用 *Set* 的 `SRANDMEMBER` 方法获取随机值后返回。

但如何保证缓存击穿呢？

1. 请求时，先返回空值或默认值，然后异步查询加载数据到缓存。这里需要考虑使用分布式锁保证多个实例只有一个线程更新缓存。
2. 缓存不设置过期时间，由服务负责定时刷新缓存。

方案 1 可以实现，但略微麻烦；方案 2 对于缓存内容不确定情况，较难实现。

#### 如果使用 Guava Cache

每个实例都保存 1 份数据，通过估算，发现这个并不是影响程序性能。且因为需求特点数据一致性要求不高，也不存在问题。

缓存击穿的保证也比较简单，使用 Guava Cache 的先返回旧值，然后异步刷新即可。

但如果遇到服务中断或重启时，先返回旧值，然后异步刷新，此时没有旧值，会导致 **数据库请求突增，多个请求线程阻塞** 的情况。

#### 选用 EhCahe

EhCache 同 Guava Cache，每个实例保留 1 分数据也能容忍，且缓存击穿也能得到保证。

对于服务中断或重启，可以使用它的磁盘持久化功能，将数据先写入磁盘，重启时从磁盘加载（可能存在缓存数据过旧的情况）。

## 解决问题

因此我选择了使用 EhCache 实现了该需求。

但通常，我们可以使用本地缓存作为一级缓存，分布式缓存作为二级缓存，这个可以减少本地缓存多次访问数据库的问题等。

## 参考文章

1. [Ehcache 与 Guava Cache 的区别浅谈 - 土豆条 - 博客园](https://www.cnblogs.com/liushijie/p/5217981.html)
2. [服务端分布式缓存与本地缓存_数据库_itafeng-CSDN 博客](https://blog.csdn.net/haoxinqing9698/article/details/102465975)
3. [17 | 高性能缓存架构-极客时间](https://time.geekbang.org/column/article/8640?utm_source=web&utm_medium=didispace&utm_campaign=changweiliuliang&utm_term=didispace010&utm_content=0530&gk_source=)

